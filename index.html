<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß‡∏•‡πâ‡∏≤‡∏á‡∏£‡∏ñ‡∏ñ‡∏∂‡∏á‡∏ö‡πâ‡∏≤‡∏ô - Delivery Car Wash</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; font-family: 'ChulaCharasNew', 'Segoe UI', Tahoma, sans-serif; }
        .card { border-radius: 15px; border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .btn-primary { background-color: #1a5d1a; border: none; }
        .btn-primary:hover { background-color: #144514; }
        .car-item { background: #fff; border-left: 5px solid #1a5d1a; margin-bottom: 10px; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .price-tag { font-size: 1.2rem; font-weight: bold; color: #1a5d1a; }
        #searchResult { z-index: 1050; }
        .address-search-container { position: relative; }
    </style>
</head>
<body>

<div class="container py-5">
    <div class="text-center mb-5">
        <h2 class="fw-bold">üßº ‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß‡∏•‡πâ‡∏≤‡∏á‡∏£‡∏ñ‡∏ñ‡∏∂‡∏á‡∏ö‡πâ‡∏≤‡∏ô</h2>
        <p class="text-muted">‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏£‡∏ñ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏û‡∏£‡∏µ‡πÄ‡∏°‡∏µ‡∏¢‡∏°‡∏ñ‡∏∂‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡πâ‡∏≤‡∏ô‡∏Ñ‡∏∏‡∏ì</p>
    </div>

    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card p-4 mb-4">
                <h5 class="mb-3 fw-bold text-success">1. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á</h5>
                <div class="mb-3">
                    <label class="form-label">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
                    <input type="tel" id="phone" class="form-control form-control-lg" placeholder="08XXXXXXXX" oninput="checkHistory(this.value)" required>
                    <div id="historyStatus" class="form-text text-success" style="display:none;">‚ú® ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ...</div>
                </div>
                <div class="mb-3">
                    <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                    <input type="text" id="custName" class="form-control" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì">
                </div>
                
                <div class="address-search-container mb-3">
                  <label class="form-label fw-bold text-primary">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏î‡πà‡∏ß‡∏ô (‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏≥‡∏ö‡∏• ‡∏´‡∏£‡∏∑‡∏≠ ‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå)</label>
                  <input type="text" id="addressSearch" class="form-control" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏•‡∏≤‡∏î‡∏û‡∏£‡πâ‡∏≤‡∏ß ‡∏´‡∏£‡∏∑‡∏≠ 10230" oninput="searchAddress(this.value)">
                  <div id="searchResult" class="list-group position-absolute w-100 shadow"></div>
                </div>

                <div class="mb-3">
                    <label class="form-label">‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà / ‡∏à‡∏∏‡∏î‡∏™‡∏±‡∏á‡πÄ‡∏Å‡∏ï</label>
                    <textarea id="addressDetail" class="form-control" rows="2" placeholder="‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà, ‡∏ã‡∏≠‡∏¢, ‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô"></textarea>
                </div>

                <div class="row g-2 mb-3">
                    <div class="col-md-6">
                        <label class="form-label text-muted small">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</label>
                        <select id="province" class="form-select" onchange="changeProvince()"></select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label text-muted small">‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</label>
                        <select id="amphure" class="form-select" onchange="changeAmphure()"></select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label text-muted small">‡∏ï‡∏≥‡∏ö‡∏•</label>
                        <select id="tambon" class="form-select" onchange="changeTambon()"></select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label text-muted small">‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå</label>
                        <input type="text" id="zipcode" class="form-control" readonly>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label small">‡∏•‡∏¥‡∏á‡∏Å‡πå Google Maps (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
                    <input type="url" id="mapUrl" class="form-control" placeholder="https://goo.gl/maps/...">
                </div>
            </div>

            <div class="card p-4 mb-4">
                <h5 class="mb-3 fw-bold text-success">2. ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏£‡∏ñ</h5>
                <div class="row g-2">
                    <div class="col-6">
                        <label class="form-label">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏ñ</label>
                        <select id="vType" class="form-select" onchange="updatePriceOptions()">
                            <option value="car">‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</option>
                            <option value="bigCar">‡∏£‡∏ñ‡πÉ‡∏´‡∏ç‡πà (6 ‡∏•‡πâ‡∏≠+)</option>
                            <option value="bike">‡∏°‡∏≠‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÑ‡∏ã‡∏Ñ‡πå</option>
                            <option value="bigBike">Big Bike (300cc+)</option>
                        </select>
                    </div>
                    <div class="col-6">
                        <label class="form-label">‡∏Ç‡∏ô‡∏≤‡∏î/‡∏£‡∏∏‡πà‡∏ô</label>
                        <select id="vSize" class="form-select" onchange="setBasePrice()"></select>
                    </div>
                </div>

                <div class="row mt-3 g-2">
                    <div class="col-6">
                        <label class="form-label small text-muted">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ê‡∏≤‡∏ô (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ)</label>
                        <input type="number" id="manualPrice" class="form-control" oninput="calculateCurrentPrice()">
                    </div>
                    <div class="col-6">
                        <label class="form-label small text-muted">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏û‡∏¥‡πÄ‡∏®‡∏© (‡∏ö‡∏≤‡∏ó)</label>
                        <input type="number" id="individualDiscount" class="form-control" oninput="calculateCurrentPrice()" value="0">
                    </div>
                </div>

                <div class="form-check mt-3" id="evOption" style="display:none;">
                    <input class="form-check-input" type="checkbox" id="isEV" onchange="calculateCurrentPrice()">
                    <label class="form-check-label">‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå EV (+100 ‡∏ö‡∏≤‡∏ó)</label>
                </div>
                <div class="form-check mt-3" id="chainOption" style="display:none;">
                    <input class="form-check-input" type="checkbox" id="isChainClean" onchange="calculateCurrentPrice()">
                    <label class="form-check-label">‡∏•‡πâ‡∏≤‡∏á‡πÇ‡∏ã‡πà + ‡πÄ‡∏Ñ‡∏•‡∏∑‡∏≠‡∏ö (+120 ‡∏ö‡∏≤‡∏ó)</label>
                </div>

                <div class="mt-4 p-3 bg-light rounded text-center border">
                    <span class="text-muted">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡∏Ñ‡∏±‡∏ô‡∏ô‡∏µ‡πâ:</span>
                    <span id="currentPriceDisplay" class="price-tag">0</span> ‡∏ø
                    <button type="button" class="btn btn-primary d-block w-100 mt-2" onclick="addCar()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏•‡∏á‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
                </div>
            </div>

            <div class="card p-4 mb-4 shadow-sm border-success" style="border-width: 2px;">
                <h5 class="mb-3 fw-bold">3. ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</h5>
                <div id="carList" class="mb-3">
                    <p class="text-muted text-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤</p>
                </div>
                <hr>
                <div class="mb-3">
                    <label class="form-label fw-bold">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</label>
                    <input type="datetime-local" id="appointTime" class="form-control">
                </div>
                <div class="p-3 bg-success bg-opacity-10 rounded">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="text-dark">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</div>
                        <div><span id="totalPrice" class="price-tag text-success fs-2">0</span> ‡∏ø</div>
                    </div>
                    <small id="discountNote" class="text-primary d-block mt-1"></small>
                </div>
                <button class="btn btn-success btn-lg w-100 mt-4 py-3 fw-bold shadow" onclick="submitBooking()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß</button>
                <small class="text-danger mt-3 d-block text-center">* ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏á‡∏™‡∏¥‡∏ï‡πÅ‡∏•‡∏∞‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á (‡∏ü‡∏£‡∏µ‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á 18 ‡∏Å‡∏°. ‡πÅ‡∏£‡∏Å)</small>
            </div>
        </div>
    </div>
</div>

<script>
    let cart = [];
    let addressData = { provinces: [], amphures: [], tambons: [] };
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxOpK7KAcAQG-DnSNl5C7aETDU5PX0ePAa95EDeU5i4DwnaYH5Gxex0ssPfAV8xEegG/exec"; 

    const defaultPrices = {
        car: { S: 350, M: 450, L: 550 },
        bigCar: { '6 ‡∏•‡πâ‡∏≠‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ': 600 },
        bike: { '‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ': 200 },
        bigBike: { '300cc+': 300 }
    };

    // --- ‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà ---
    async function loadAddressData() {
        try {
            const [p, a, t] = await Promise.all([
                fetch('province.json').then(res => res.json()),
                fetch('amphor.json').then(res => res.json()),
                fetch('tumbon.json').then(res => res.json())
            ]);
            addressData = { provinces: p, amphures: a, tambons: t };
            
            const pSelect = document.getElementById('province');
            pSelect.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</option>';
            addressData.provinces.sort((a,b) => a.name_th.localeCompare(b.name_th)).forEach(item => {
                pSelect.options.add(new Option(item.name_th, item.id));
            });
        } catch (err) { console.error("Error loading address:", err); }
    }

    function changeProvince() {
        const pId = document.getElementById('province').value;
        const aSelect = document.getElementById('amphure');
        const tSelect = document.getElementById('tambon');
        aSelect.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</option>';
        tSelect.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡∏ö‡∏•</option>';
        document.getElementById('zipcode').value = '';

        if(!pId) return;
        const filtered = addressData.amphures.filter(item => item.province_id == pId);
        filtered.forEach(item => aSelect.options.add(new Option(item.name_th, item.id)));
    }

    function changeAmphure() {
        const aId = document.getElementById('amphure').value;
        const tSelect = document.getElementById('tambon');
        tSelect.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡∏ö‡∏•</option>';
        document.getElementById('zipcode').value = '';

        if(!aId) return;
        const filtered = addressData.tambons.filter(item => item.amphure_id == aId);
        filtered.forEach(item => tSelect.options.add(new Option(item.name_th, item.id)));
    }

    function changeTambon() {
        const tId = document.getElementById('tambon').value;
        const tambon = addressData.tambons.find(item => item.id == tId);
        if (tambon) document.getElementById('zipcode').value = tambon.zip_code;
    }

    function searchAddress(query) {
        const resultBox = document.getElementById('searchResult');
        if (query.length < 2) {
            resultBox.innerHTML = '';
            return;
        }

        const matches = addressData.tambons.filter(item => 
            item.zip_code.toString().includes(query) || item.name_th.includes(query)
        ).slice(0, 10);

        resultBox.innerHTML = matches.map(item => {
            const amphure = addressData.amphures.find(a => a.id === item.amphure_id);
            const province = addressData.provinces.find(p => p.id === (amphure ? amphure.province_id : null));
            if(!amphure || !province) return '';
            
            return `
                <button type="button" class="list-group-item list-group-item-action py-2" 
                    onclick="selectAddress(${item.id}, ${amphure.id}, ${province.id}, '${item.zip_code}')">
                    <strong>${item.name_th}</strong> > ${amphure.name_th} > ${province.name_th} (${item.zip_code})
                </button>
            `;
        }).join('');
    }

    function selectAddress(tId, aId, pId, zip) {
        document.getElementById('province').value = pId;
        changeProvince();
        document.getElementById('amphure').value = aId;
        changeAmphure();
        document.getElementById('tambon').value = tId;
        document.getElementById('zipcode').value = zip;
        document.getElementById('searchResult').innerHTML = '';
        document.getElementById('addressSearch').value = '';
    }

    // --- ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏Ñ‡∏≤ ---
    function updatePriceOptions() {
        const type = document.getElementById('vType').value;
        const sizeSelect = document.getElementById('vSize');
        const evOpt = document.getElementById('evOption');
        const chainOpt = document.getElementById('chainOption');

        sizeSelect.innerHTML = '';
        if (type === 'car') {
            sizeSelect.innerHTML = `<option value="S">S (Yaris, City)</option><option value="M">M (Civic, Altis)</option><option value="L">L (SUV, ‡∏Å‡∏£‡∏∞‡∏ö‡∏∞)</option>`;
            evOpt.style.display = 'block';
            chainOpt.style.display = 'none';
        } else {
            const label = type === 'bike' ? '‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ' : (type === 'bigBike' ? '300cc+' : '6 ‡∏•‡πâ‡∏≠‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ');
            sizeSelect.innerHTML = `<option value="${label}">${label}</option>`;
            evOpt.style.display = 'none';
            chainOpt.style.display = (type === 'bike' || type === 'bigBike') ? 'block' : 'none';
        }
        setBasePrice();
    }

    function setBasePrice() {
        const type = document.getElementById('vType').value;
        const size = document.getElementById('vSize').value;
        document.getElementById('manualPrice').value = defaultPrices[type][size] || 0;
        calculateCurrentPrice();
    }

    function calculateCurrentPrice() {
        const type = document.getElementById('vType').value;
        let basePrice = parseInt(document.getElementById('manualPrice').value) || 0;
        let discount = parseInt(document.getElementById('individualDiscount').value) || 0;
        let extra = 0;

        const isEV = document.getElementById('isEV');
        const isChain = document.getElementById('isChainClean');
        if (type === 'car' && isEV.checked) extra += 100;
        if ((type === 'bike' || type === 'bigBike') && isChain.checked) extra += 120;

        let finalPrice = (basePrice + extra) - discount;
        document.getElementById('currentPriceDisplay').innerText = finalPrice < 0 ? 0 : finalPrice;
    }

    // --- ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ---
    function addCar() {
        const typeSelect = document.getElementById('vType');
        const sizeSelect = document.getElementById('vSize');
        const price = parseInt(document.getElementById('currentPriceDisplay').innerText);
        
        if(price <= 0) {
            alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ñ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
            return;
        }

        const car = {
            typeName: typeSelect.options[typeSelect.selectedIndex].text,
            size: sizeSelect.value,
            basePrice: document.getElementById('manualPrice').value,
            discount: document.getElementById('individualDiscount').value,
            addon: document.getElementById('isEV').checked ? "EV" : (document.getElementById('isChainClean').checked ? "‡∏•‡πâ‡∏≤‡∏á‡πÇ‡∏ã‡πà" : "-"),
            price: price
        };

        cart.push(car);
        renderCart();
        
        // Reset inputs
        document.getElementById('individualDiscount').value = 0;
        document.getElementById('isEV').checked = false;
        document.getElementById('isChainClean').checked = false;
    }

    function renderCart() {
        const list = document.getElementById('carList');
        if (cart.length === 0) {
            list.innerHTML = '<p class="text-muted text-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤</p>';
            document.getElementById('totalPrice').innerText = '0';
            document.getElementById('discountNote').innerText = '';
            return;
        }

        list.innerHTML = '';
        let total = 0;
        cart.forEach((item, index) => {
            total += item.price;
            list.innerHTML += `
                <div class="car-item d-flex justify-content-between align-items-center">
                    <div>
                        <strong class="text-dark">${item.typeName}</strong> <span class="badge bg-secondary">${item.size}</span>
                        <br><small class="text-muted">‡πÄ‡∏™‡∏£‡∏¥‡∏°: ${item.addon} | ‡∏•‡∏î: ${item.discount}‡∏ø</small>
                    </div>
                    <div class="text-end">
                        <div class="fw-bold text-success">${item.price} ‡∏ø</div>
                        <button class="btn btn-sm btn-outline-danger border-0" onclick="removeFromCart(${index})">‡∏•‡∏ö</button>
                    </div>
                </div>`;
        });

        let finalTotal = total;
        let note = "";
        if (cart.length >= 10) {
            finalTotal *= 0.85;
            note = "üéâ ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏° 10 ‡∏Ñ‡∏±‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ (-15%)";
        } else if (cart.length >= 5) {
            finalTotal *= 0.90;
            note = "üéâ ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏° 5 ‡∏Ñ‡∏±‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ (-10%)";
        }
        
        document.getElementById('totalPrice').innerText = Math.round(finalTotal).toLocaleString();
        document.getElementById('discountNote').innerText = note;
    }

    function removeFromCart(index) {
        cart.splice(index, 1);
        renderCart();
    }

    // --- ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ---
    async function submitBooking() {
        const btn = document.querySelector("button[onclick='submitBooking()']");
        try {
            const pEl = document.getElementById('province');
            const name = document.getElementById('custName').value;
            const phone = document.getElementById('phone').value;
            const time = document.getElementById('appointTime').value;

            if (!pEl.value || !phone || !time) {
                alert("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà ‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô");
                return;
            }
            if (cart.length === 0) {
                alert("üõí ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏ñ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏Ñ‡∏±‡∏ô");
                return;
            }

            btn.disabled = true;
            btn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...";

            const fullAddress = `${document.getElementById('addressDetail').value} ‡∏ï.${document.getElementById('tambon').options[document.getElementById('tambon').selectedIndex].text} ‡∏≠.${document.getElementById('amphure').options[document.getElementById('amphure').selectedIndex].text} ‡∏à.${pEl.options[pEl.selectedIndex].text} ${document.getElementById('zipcode').value}`;
            
            const data = {
                customerName: name,
                phone: phone,
                address: fullAddress,
                mapUrl: document.getElementById('mapUrl').value,
                appointment: time,
                cars: cart,
                totalPrice: document.getElementById('totalPrice').innerText
            };

            await fetch(WEB_APP_URL, { 
                method: 'POST', 
                mode: 'no-cors', 
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify(data) 
            });

            alert("‚úÖ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏•‡∏±‡∏ö‡πÇ‡∏î‡∏¢‡πÄ‡∏£‡πá‡∏ß‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î");
            location.reload();

        } catch (e) {
            alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + e.message);
            btn.disabled = false;
            btn.innerText = "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß";
        }
    }

    // --- ‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ ---
    let isFetching = false;
    async function checkHistory(phone) {
    // ‡∏ï‡πâ‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏£‡∏ö 10 ‡∏´‡∏•‡∏±‡∏Å‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏´‡∏≤
    if (phone.length === 10) {
        console.log("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏ö‡∏≠‡∏£‡πå:", phone);
        

        try {
            const response = await fetch(`${WEB_APP_URL}?action=getHistory&phone=${phone}`);
            
            if (!response.ok) throw new Error('Network response was not ok');
            
            const data = await response.json();

            if (data.found) {
                // ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°
                document.getElementById('custName').value = data.name || '';
                
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÉ‡∏ä‡πâ ID address ‡∏´‡∏£‡∏∑‡∏≠ addressDetail
                const addrField = document.getElementById('addressDetail') || document.getElementById('address');
                if (addrField) addrField.value = data.address || '';
                
                if (document.getElementById('mapUrl')) {
                    document.getElementById('mapUrl').value = data.mapUrl || '';
                }
                
                alert("‚ú® ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤! ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö");
            } else {
                console.log("‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö");
            }
        } catch (error) {
            console.error("Fetch error:", error);
        }
    }
}

    window.addEventListener('DOMContentLoaded', () => {
        loadAddressData();
        updatePriceOptions();
    });
</script>
</body>
</html>